{"componentChunkName":"component---src-templates-blog-post-js","path":"/yeats/","result":{"data":{"site":{"siteMetadata":{"title":"mattswoon"}},"markdownRemark":{"id":"6b914a38-907d-582b-b168-4ad312835205","excerpt":"Irish This game probably has a lot of names, I‚Äôve not met many who call it Irish. Everyone puts clues into a bowl, they can be anything: a celebrity, a‚Ä¶","html":"<h2>Irish</h2>\n<p>This game probably has a lot of names, I‚Äôve not met many who call it Irish.</p>\n<p>Everyone puts clues into a bowl, they can be anything: a celebrity, a character, an event, an in-joke, a song, a lyric,\none of euclids axioms, an emotion‚Ä¶</p>\n<p>Then there‚Äôs three rounds where everyone takes at turn at pulling clues out of the bowl and performing them to some other people.\nIn each round the mode of performance changes</p>\n<ol>\n<li>use any words that aren‚Äôt written on the clue</li>\n<li>use one word and and one word only</li>\n<li>charades</li>\n</ol>\n<p>You can invent more rounds if you want, the point is that successful performances don‚Äôt need to\ndescribe the clue precisely but you can use in-jokes and throw backs to the previous rounds to help the person guessing. Some suggestions\nfor playing this on discord include</p>\n<ul>\n<li>Sound effects only (I guess this is the radio drama version of charades?)</li>\n<li>Emojis only üë®üíÄüåØ‚û°Ô∏è‚úã (<a href=\"https://www.imdb.com/title/tt0172543/?ref_=fn_al_tt_1\">‚ÄúHe Died with Felafel in His Hand‚Äù</a> ??)</li>\n</ul>\n<h3>Quarantine</h3>\n<p>With the global pandemic in full swing and all this talk of flattening the curve,\ngathering with a large enough group of friends to play is not possible.\nSo I made a discord bot so we can play it virtually.</p>\n<p>The bot, named Yeats because he was Irish and the special topic of one of my friends when she went on the hard quiz,\nmanages the bowl of clues, the turn order and showing clues to the person who‚Äôs performing that turn.</p>\n<p>Yeats is written in JavaScript and I‚Äôve never written JavaScript before,\nso while I‚Äôm showing you what I‚Äôve done, this is\nnot supposed to be a tutorial!</p>\n<p>Those who don‚Äôt care and just want to see the code,\nit‚Äôs on my <a href=\"https://github.com/mattswoon/yeats\">GitHub</a>.</p>\n<h3>Yeats game state</h3>\n<p>To run the game there‚Äôs a number of different classes I‚Äôve used to record various aspects of the game state, they are</p>\n<ul>\n<li><code class=\"language-text\">Game</code>: Overall game state - what round we‚Äôre in (many words, one word, charades‚Ä¶), who are the players, the current turn state, the bowl (where clues are kept) state, the channel to send messages to,\nwhether the game is locked or not (when locked you can‚Äôt add new clues or players)</li>\n<li><code class=\"language-text\">Bowl</code>: The collection of clues, which ones have been solved and which ones remain unsolved</li>\n<li><code class=\"language-text\">Turn</code>: Info about the current turn - who‚Äôs performing to whom, whether the turn is <code class=\"language-text\">READY</code>, <code class=\"language-text\">RUNNING</code> or <code class=\"language-text\">FINISHED</code>, which clues have been solved, which clue is currently being shown</li>\n<li><code class=\"language-text\">Players</code>: State of the turn order - who‚Äôs playing, the turn queue, a map of who‚Äôll be performing and who‚Äôll be guessing</li>\n</ul>\n<h3>Running turns</h3>\n<p>Most of the game runs by fairly simple game state transitions:</p>\n<ul>\n<li>When a turn is prepped a player gets popped out of the turn queue, the bowl gets shuffled, the turn state is set to <code class=\"language-text\">READY</code> and a message gets sent to the channel\nnotifying the performer and the guesser that they should be ready</li>\n<li>When the turn ends the last shown clue (which is still unsolved) is put back into the bowl, the performer is pushed onto a ‚Äúhad turn‚Äù array, the clues that were solved during the turn\nget put into a ‚Äúsolved clues‚Äù array and the channel gets a recap of which clues were solved during the turn</li>\n</ul>\n<p>The first difficulty I encountered was dealing with the two ways a turn can end</p>\n<ul>\n<li>A turn ends 90s (or some defined time period) after it starts, or</li>\n<li>When the bowl is empty of clues</li>\n</ul>\n<p>The difficulty is with the way I implemented the first option, using async/await and a promise that resolves after some delay (the turn time). Those are javascript words,\nand I don‚Äôt fully understand them, so don‚Äôt worry if you don‚Äôt either.</p>\n<h4>A problem :(</h4>\n<p>So the issue was this, when a turn is started the following happens</p>\n<ol>\n<li>The turn state is set to <code class=\"language-text\">RUNNING</code></li>\n<li>A clue is shown to the performer</li>\n<li>await for the delay function to finish</li>\n<li>end the turn</li>\n</ol>\n<p>While awaiting the delay function to finish, yeats listens for any message from the performer (either via dm or in the text channel) and takes that message to mean\n‚Äúwe‚Äôve solved this clue, give me the next please‚Äù. Now what happens if there‚Äôs no more clues? It‚Äôd be annoying to have to wait out the turn time for the turn to end,\nso we‚Äôd prefer to end the turn there, and get ready for the next round.</p>\n<p>Now if we just fire off an <code class=\"language-text\">endTurn</code> directive when the bowl is emptied, we could end the turn. The problem being that the awaiting start turn function will also\ntry to end the turn when the delay finishes, meaning we‚Äôll be trying to end the turn twice.</p>\n<p>We could do a check on the turn state when we end the turn, to make sure the turn is still running first. But then the following is possible: </p>\n<ol>\n<li>A turn starts</li>\n<li>The perfomer solves all the clues in the bowl, so the turn ends (and its state set to <code class=\"language-text\">FINISHED</code>)</li>\n<li>We start the next round and start the next turn (setting the turn state to <code class=\"language-text\">READY</code> and then <code class=\"language-text\">RUNNING</code>)</li>\n<li>The function from bullet 1. finishes awaiting and sends an <code class=\"language-text\">endTurn</code>, and now since the current turn has a <code class=\"language-text\">RUNNING</code> state, <em>it</em> becomes the turn to end.</li>\n</ol>\n<p>This is clearly not how the game should work. How do we fix it?</p>\n<h4>A solution :)</h4>\n<p>There may be better ways, but here‚Äôs what I did: When a turn is prepped, not only is its state set to <code class=\"language-text\">READY</code> but it is given a random identifier - I guess a plain old\nrandom number could do, but I used uuids because I like the way the look. Then, when we send an <code class=\"language-text\">endTurn</code>, we don‚Äôt just say ‚Äúend the current turn‚Äù, we say\n‚Äúend the turn with identifier X‚Äù. Now we still check the current turn is running, but we <em>also</em> check that the current turn has the same identifier as the turn\nwe‚Äôve asked yeats to end.</p>\n<p>In the example above, when we try to end the turn from bullet 1. in bullet 4. yeats will notice that the turn we‚Äôre trying to end isn‚Äôt the same turn that‚Äôs currently\nrunning, and so will do nothing (except log that an <code class=\"language-text\">endTurn</code> came in for an obselete turn, so we know it‚Äôs working).</p>\n<h2>Some more details</h2>\n<p>For those interested, here‚Äôs a little bit more of ‚Äúhow‚Äù.</p>\n<h3>Make a discord bot</h3>\n<p>Creating a discord bot is pretty straightforward, just follow the instructions over <a href=\"https://discordpy.readthedocs.io/en/latest/discord.html\">here</a>.</p>\n<p>All we need is the  secret token, which I‚Äôve saved to a file in my repository called <code class=\"language-text\">.profile</code> (which is in the <code class=\"language-text\">.gitignore</code> so I don‚Äôt\ncommit it for all the world to see), which I can <code class=\"language-text\">source</code> to as an environment variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">YEATS_TOKEN</span><span class=\"token operator\">=</span><span class=\"token string\">\"SoMeChArAcTeRsAnDPuNcTuaTioNandStuFf\"</span></code></pre></div>\n<h3>Bot basics</h3>\n<p>I‚Äôd not really done any javascript programming before but some discord bot tutorials got me up and running. The process was something like</p>\n<ol>\n<li>Install <a href=\"https://nodejs.org/en/download/\"><code class=\"language-text\">node</code></a> and <a href=\"%5B200~https://www.npmjs.com/get-npm\"><code class=\"language-text\">npm</code></a> and whatever</li>\n<li>Run <code class=\"language-text\">npm init</code> and follow the instructions</li>\n<li><code class=\"language-text\">npm install discordjs</code></li>\n<li>Start coding</li>\n</ol>\n<p>The basics of yeats is to connect using the above secret token, then listen for messages and update the game state accordingly.\nSo it all started off looking something like</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Discord <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'discord.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ntoken <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">YEATS_TOKEN</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Connecting with token=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>token<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Discord<span class=\"token punctuation\">.</span>Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">once</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ready'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Connected and ready'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">'text'</span> <span class=\"token operator\">&amp;</span> message<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> <span class=\"token string\">'Hello yeats'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">.</span><span class=\"token function\">reply</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Hello </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>message<span class=\"token punctuation\">.</span>author<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Adding commands</h3>\n<p>To add commands to yeats‚Äôs repertoire, we just need to add more <code class=\"language-text\">if</code> statements in the <code class=\"language-text\">&#39;message&#39;</code> event listener.\nI have three main blocks - one for commands (they start with <code class=\"language-text\">!</code>) DM‚Äôd to yeats, one for commands in the text channel, and one for the performer asking for a new clue.\nSo the <code class=\"language-text\">&#39;message&#39;</code> listener looks more like </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">client<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'text'</span> <span class=\"token operator\">&amp;</span> message<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    command <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'!add-players'</span> \n        <span class=\"token comment\">// stuff</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'!start-game'</span>\n        <span class=\"token comment\">// stuff</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'!next-turn'</span>\n        <span class=\"token comment\">// stuff</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'!start-turn'</span>\n        <span class=\"token comment\">// stuff</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// and so on</span>\n      <span class=\"token keyword\">default</span>\n        message<span class=\"token punctuation\">.</span><span class=\"token function\">reply</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unknown command'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>channel<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'dm'</span> <span class=\"token operator\">&amp;</span> message<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    command <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'add-clue'</span>\n        <span class=\"token comment\">// stuff</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">default</span> \n        message<span class=\"token punctuation\">.</span><span class=\"token function\">reply</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Unknown command'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>author <span class=\"token operator\">===</span> game<span class=\"token punctuation\">.</span>turn<span class=\"token punctuation\">.</span>performer <span class=\"token operator\">&amp;</span> game<span class=\"token punctuation\">.</span>turn<span class=\"token punctuation\">.</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// give next clue as a DM</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Thanks for reading</h2>\n<p>I won‚Äôt go into detail about how I‚Äôve coded all the game state transitions, but if you‚Äôre interested you can check out all the code on <a href=\"https://github.com/mattswoon/yeats\">GitHub</a>.</p>\n<p>If you‚Äôve got an improvement or find a bug, submit an issue or PR :)</p>","frontmatter":{"title":"Playing parlour games on discord during lockdown","date":"April 04, 2020","description":"My circle of friends call this game irish, and seeing as we can't see each other during the lockdown, I wrote a discord bot so we can play it OL"}}},"pageContext":{"slug":"/yeats/","previous":{"fields":{"slug":"/bikes/"},"frontmatter":{"title":"A brief history of (my) bikes"}},"next":null}}}